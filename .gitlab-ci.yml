# VIRIDA - Pipeline GitLab CI/CD Int√©gr√©
# Int√©gration avec votre structure GitLab existante

stages:
  - validate
  - test
  - build
  - deploy
  - notify

# Cache global optimis√© pour VIRIDA
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - node_modules/
    - .npm/
    - build/
    - dist/

# Variables globales VIRIDA
variables:
  VIRIDA_PROJECT: "VIRIDA"
  VIRIDA_VERSION: "1.0.0"
  NODE_ENV: "production"

# Validation du code VIRIDA
validate:
  stage: validate
  image: node:18-alpine
  script:
    - echo "üîç Validation VIRIDA - Structure GitLab int√©gr√©e"
    - echo "Projet: $VIRIDA_PROJECT"
    - echo "Branche: $CI_COMMIT_REF_NAME"
    - npm ci --only=production --silent
    - npm run lint || echo "‚ö†Ô∏è Linting non configur√© - √† configurer"
    - echo "‚úÖ Validation VIRIDA termin√©e"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/

# Tests VIRIDA
test:
  stage: test
  image: node:18-alpine
  script:
    - echo "üß™ Tests VIRIDA - Int√©gration GitLab"
    - echo "Groupe: Devops, Frontend, IoT, Management, Shared, Web App"
    - npm ci --only=production --silent
    - npm test || echo "‚ö†Ô∏è Tests non configur√©s - √† configurer"
    - echo "‚úÖ Tests VIRIDA termin√©s"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

# Construction VIRIDA
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo "üèóÔ∏è Construction VIRIDA - Int√©gration GitLab"
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - echo "Construction pour: $CI_COMMIT_REF_NAME"
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    - echo "‚úÖ Construction VIRIDA termin√©e"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH == "develop"

# D√©ploiement en d√©veloppement
deploy-dev:
  stage: deploy
  image: alpine:latest
  before_script:
    - echo "üöÄ D√©ploiement VIRIDA en d√©veloppement"
    - echo "Int√©gration avec groupes: Devops, Frontend, IoT"
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$DEV_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$DEV_SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "D√©ploiement VIRIDA sur: $DEV_HOST"
    - ssh $DEV_USER@$DEV_HOST "cd $DEV_PATH && git pull origin develop"
    - ssh $DEV_USER@$DEV_HOST "cd $DEV_PATH && docker-compose pull"
    - ssh $DEV_USER@$DEV_HOST "cd $DEV_PATH && docker-compose up -d"
    - echo "‚úÖ D√©ploiement VIRIDA en d√©veloppement termin√©"
  environment:
    name: development
    url: $DEV_URL
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  when: manual

# D√©ploiement en production
deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - echo "üöÄ D√©ploiement VIRIDA en production"
    - echo "Tous les groupes VIRIDA d√©ploy√©s"
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$PROD_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$PROD_SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "D√©ploiement VIRIDA sur: $PROD_HOST"
    - ssh $PROD_USER@$PROD_HOST "cd $PROD_PATH && git pull origin $CI_DEFAULT_BRANCH"
    - ssh $PROD_USER@$PROD_HOST "cd $PROD_PATH && docker-compose pull"
    - ssh $PROD_USER@$PROD_HOST "cd $PROD_PATH && docker-compose up -d"
    - echo "‚úÖ D√©ploiement VIRIDA en production termin√©"
  environment:
    name: production
    url: $PROD_URL
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: manual

# Notification de succ√®s VIRIDA
notify-success:
  stage: notify
  image: alpine:latest
  before_script:
    - echo "üì¢ Notification VIRIDA - Succ√®s"
    - apk add --no-cache curl
  script:
    - echo "Pipeline VIRIDA r√©ussi pour: $CI_COMMIT_REF_NAME"
    - |
      if [ -n "$DISCORD_WEBHOOK_URL" ]; then
        curl -H "Content-Type: application/json" \
             -d "{\"content\":\"‚úÖ Pipeline VIRIDA r√©ussi pour $CI_COMMIT_REF_NAME - Groupe: $CI_PROJECT_NAME\"}" \
             $DISCORD_WEBHOOK_URL
      fi
    - echo "‚úÖ Notification VIRIDA envoy√©e"
  rules:
    - if: $CI_PIPELINE_STATUS == "success"
  when: always

# Notification d'√©chec VIRIDA
notify-failure:
  stage: notify
  image: alpine:latest
  before_script:
    - echo "üì¢ Notification VIRIDA - √âchec"
    - apk add --no-cache curl
  script:
    - echo "Pipeline VIRIDA √©chou√© pour: $CI_COMMIT_REF_NAME"
    - |
      if [ -n "$DISCORD_WEBHOOK_URL" ]; then
        curl -H "Content-Type: application/json" \
             -d "{\"content\":\"‚ùå Pipeline VIRIDA √©chou√© pour $CI_COMMIT_REF_NAME - Groupe: $CI_PROJECT_NAME\"}" \
             $DISCORD_WEBHOOK_URL
      fi
    - echo "‚úÖ Notification VIRIDA envoy√©e"
  rules:
    - if: $CI_PIPELINE_STATUS == "failed"
  when: always


