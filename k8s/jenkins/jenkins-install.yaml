# üöÄ VIRIDA Jenkins Installation
# Configuration CI/CD compl√®te avec Jenkins

---
# Namespace Jenkins
apiVersion: v1
kind: Namespace
metadata:
  name: jenkins
  labels:
    name: jenkins
    purpose: ci-cd
    environment: clever-cloud
---
# ServiceAccount Jenkins
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins-admin
  namespace: jenkins
  labels:
    app.kubernetes.io/name: jenkins
    app.kubernetes.io/part-of: virida
---
# ClusterRole Jenkins
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: jenkins-admin
  labels:
    app.kubernetes.io/name: jenkins-admin
    app.kubernetes.io/part-of: virida
rules:
  - apiGroups: [""]
    resources: ["*"]
    verbs: ["*"]
  - apiGroups: ["apps"]
    resources: ["*"]
    verbs: ["*"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["*"]
    verbs: ["*"]
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["*"]
    verbs: ["*"]
  - apiGroups: ["batch"]
    resources: ["*"]
    verbs: ["*"]
---
# ClusterRoleBinding Jenkins
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jenkins-admin-binding
  labels:
    app.kubernetes.io/name: jenkins-admin-binding
    app.kubernetes.io/part-of: virida
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: jenkins-admin
subjects:
  - kind: ServiceAccount
    name: jenkins-admin
    namespace: jenkins
---
# PersistentVolumeClaim pour Jenkins
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jenkins-data
  namespace: jenkins
  labels:
    app.kubernetes.io/name: jenkins
    app.kubernetes.io/part-of: virida
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: local-path
---
# ConfigMap Jenkins
apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-config
  namespace: jenkins
  labels:
    app.kubernetes.io/name: jenkins-config
    app.kubernetes.io/part-of: virida
data:
  # Configuration Jenkins
  jenkins.yaml: |
    jenkins:
      systemMessage: "VIRIDA Jenkins CI/CD Server"
      numExecutors: 2
      scmCheckoutRetryCount: 3
      mode: NORMAL
      labelString: "VIRIDA"
      
      # Configuration des plugins
      installPlugins:
        - kubernetes:1.31.3
        - workflow-aggregator:2.6
        - git:4.15.1
        - configuration-as-code:1.57
        - blueocean:1.25.8
        - pipeline-stage-view:2.28
        - build-timeout:1.24
        - timestamper:1.23
        - warnings-ng:11.0.0
        - junit:1.57
        - cobertura:1.17
        - sonar:2.15
        - docker-plugin:1.5
        - kubernetes-cli:1.10.7
        - slack:2.48
        - email-ext:2.91
        - matrix-auth:3.1.1
        - ldap:2.10
        - active-directory:2.28
        - role-strategy:3.3.1
        
      # Configuration de s√©curit√©
      securityRealm:
        local:
          allowsSignup: false
          users:
            - id: "admin"
              password: "${JENKINS_ADMIN_PASSWORD}"
              
      # Configuration des autorisations
      authorizationStrategy:
        globalMatrix:
          permissions:
            - "Overall/Administer:admin"
            - "Overall/Read:authenticated"
            - "Job/Build:authenticated"
            - "Job/Read:authenticated"
            
      # Configuration des clouds Kubernetes
      clouds:
        - kubernetes:
            name: "virida-kubernetes"
            serverUrl: "https://kubernetes.default.svc"
            jenkinsUrl: "http://jenkins:8080"
            jenkinsTunnel: "jenkins:50000"
            containerCapStr: "10"
            maxRequestsPerHostStr: "32"
            namespace: "jenkins"
            templates:
              - name: "jenkins-agent"
                namespace: "jenkins"
                label: "jenkins-agent"
                containers:
                  - name: "jnlp"
                    image: "jenkins/inbound-agent:latest"
                    workingDir: "/home/jenkins/agent"
                    command:
                      - "cat"
                    ttyEnabled: true
                    resourceRequestCpu: "500m"
                    resourceRequestMemory: "512Mi"
                    resourceLimitCpu: "1000m"
                    resourceLimitMemory: "1Gi"
                volumes:
                  - name: "workspace-volume"
                    emptyDir: {}
                workspaceVolume:
                  emptyDirWorkspaceVolume:
                    memory: false
                yaml: |
                  spec:
                    containers:
                    - name: docker
                      image: docker:latest
                      command:
                      - cat
                      tty: true
                      securityContext:
                        privileged: true
                      volumeMounts:
                      - name: docker-sock
                        mountPath: /var/run/docker.sock
                    volumes:
                    - name: docker-sock
                      hostPath:
                        path: /var/run/docker.sock
                        
      # Configuration des outils
      tool:
        git:
          installations:
            - name: "Default"
              home: "git"
        maven:
          installations:
            - name: "Maven-3.8.6"
              home: "/opt/maven"
        jdk:
          installations:
            - name: "JDK-17"
              home: "/opt/java/openjdk-17"
        nodejs:
          installations:
            - name: "NodeJS-18"
              home: "/opt/node"
---
# Secret Jenkins
apiVersion: v1
kind: Secret
metadata:
  name: jenkins-secrets
  namespace: jenkins
  labels:
    app.kubernetes.io/name: jenkins-secrets
    app.kubernetes.io/part-of: virida
type: Opaque
data:
  # Ces valeurs seront remplac√©es par les vraies valeurs
  jenkins-admin-password: YWRtaW4xMjM=  # admin123 en base64
  gitea-token: YWRtaW4xMjM=  # √Ä remplacer par le vrai token
  docker-registry-credentials: YWRtaW4xMjM=  # √Ä remplacer
---
# Deployment Jenkins
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
  namespace: jenkins
  labels:
    app.kubernetes.io/name: jenkins
    app.kubernetes.io/part-of: virida
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: jenkins
  template:
    metadata:
      labels:
        app.kubernetes.io/name: jenkins
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
    spec:
      serviceAccountName: jenkins-admin
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: jenkins
          image: jenkins/jenkins:lts-jdk17
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: jnlp
              containerPort: 50000
              protocol: TCP
          env:
            - name: JAVA_OPTS
              value: "-Djenkins.install.runSetupWizard=false -Djenkins.install.runSetupWizard=false"
            - name: JENKINS_UC
              value: "https://updates.jenkins.io"
            - name: JENKINS_UC_DOWNLOAD
              value: "https://updates.jenkins.io/download"
            - name: JENKINS_UC_EXPERIMENTAL
              value: "https://updates.jenkins.io/experimental"
            - name: JENKINS_INCREMENTALS_REPO_MIRROR
              value: "https://repo.jenkins-ci.org/incrementals/"
            - name: JENKINS_SLAVE_AGENT_PORT
              value: "50000"
            - name: JENKINS_SLAVE_AGENT_PORT_ENABLE
              value: "true"
            - name: JENKINS_OPTS
              value: "--prefix=/jenkins"
          resources:
            limits:
              cpu: 2000m
              memory: 4Gi
            requests:
              cpu: 1000m
              memory: 2Gi
          volumeMounts:
            - name: jenkins-data
              mountPath: /var/jenkins_home
            - name: jenkins-config
              mountPath: /var/jenkins_home/casc_configs
            - name: jenkins-secrets
              mountPath: /var/jenkins_home/secrets
          livenessProbe:
            httpGet:
              path: /login
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /login
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: jenkins-data
          persistentVolumeClaim:
            claimName: jenkins-data
        - name: jenkins-config
          configMap:
            name: jenkins-config
        - name: jenkins-secrets
          secret:
            secretName: jenkins-secrets
---
# Service Jenkins
apiVersion: v1
kind: Service
metadata:
  name: jenkins
  namespace: jenkins
  labels:
    app.kubernetes.io/name: jenkins
    app.kubernetes.io/part-of: virida
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: 8080
    - name: jnlp
      port: 50000
      protocol: TCP
      targetPort: 50000
  selector:
    app.kubernetes.io/name: jenkins
---
# Ingress Jenkins
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jenkins-ingress
  namespace: jenkins
  labels:
    app.kubernetes.io/name: jenkins-ingress
    app.kubernetes.io/part-of: virida
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: jenkins.virida.local
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: jenkins
                port:
                  number: 80

