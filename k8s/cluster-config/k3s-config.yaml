# ☸️ VIRIDA K3s Cluster Configuration
# Configuration optimisée pour le développement et la production

apiVersion: v1
kind: ConfigMap
metadata:
  name: k3s-config
  namespace: kube-system
data:
  # Configuration du cluster
  cluster-cidr: "10.42.0.0/16"
  service-cidr: "10.43.0.0/16"
  cluster-domain: "virida.local"
  
  # Configuration des ressources
  default-request-memory: "128Mi"
  default-request-cpu: "100m"
  default-limit-memory: "512Mi"
  default-limit-cpu: "500m"
  
  # Configuration de sécurité
  enable-network-policy: "true"
  enable-pod-security-policy: "true"
  enable-rbac: "true"
  
  # Configuration du monitoring
  enable-metrics-server: "true"
  enable-prometheus: "true"
  
  # Configuration du stockage
  default-storage-class: "local-path"
  enable-local-storage: "true"
---
# Configuration des namespaces VIRIDA
apiVersion: v1
kind: Namespace
metadata:
  name: virida-system
  labels:
    name: virida-system
    purpose: infrastructure
---
apiVersion: v1
kind: Namespace
metadata:
  name: virida-apps
  labels:
    name: virida-apps
    purpose: applications
---
apiVersion: v1
kind: Namespace
metadata:
  name: virida-monitoring
  labels:
    name: virida-monitoring
    purpose: monitoring
---
apiVersion: v1
kind: Namespace
metadata:
  name: argocd
  labels:
    name: argocd
    purpose: gitops
---
# Configuration RBAC pour VIRIDA
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: virida-admin
rules:
  - apiGroups: [""]
    resources: ["*"]
    verbs: ["*"]
  - apiGroups: ["apps"]
    resources: ["*"]
    verbs: ["*"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["*"]
    verbs: ["*"]
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["*"]
    verbs: ["*"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: virida-admin-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: virida-admin
subjects:
  - kind: ServiceAccount
    name: virida-admin
    namespace: virida-system
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: virida-admin
  namespace: virida-system
---
# Configuration du réseau
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny
  namespace: virida-apps
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-monitoring
  namespace: virida-apps
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              name: virida-monitoring
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 9090
---
# Configuration des ressources par défaut
apiVersion: v1
kind: LimitRange
metadata:
  name: virida-resource-limits
  namespace: virida-apps
spec:
  limits:
    - type: Container
      default:
        memory: "512Mi"
        cpu: "500m"
      defaultRequest:
        memory: "128Mi"
        cpu: "100m"
      max:
        memory: "2Gi"
        cpu: "1000m"
      min:
        memory: "64Mi"
        cpu: "50m"
---
# Configuration des quotas
apiVersion: v1
kind: ResourceQuota
metadata:
  name: virida-quota
  namespace: virida-apps
spec:
  hard:
    requests.cpu: "4"
    requests.memory: "8Gi"
    limits.cpu: "8"
    limits.memory: "16Gi"
    pods: "20"
    services: "10"
    persistentvolumeclaims: "10"

