# ðŸš€ VIRIDA Staging Environment
# Configuration Docker Compose pour l'environnement de staging

version: '3.8'

services:
  # ========================================
  # FRONTEND SERVICES
  # ========================================
  frontend-3d:
    image: virida/3d-visualizer:staging
    container_name: virida-3d-staging
    environment:
      - NODE_ENV=staging
      - REACT_APP_API_URL=https://staging-api.virida.com/api
      - REACT_APP_3D_ENGINE=threejs
    ports:
      - "3000:3000"
    networks:
      - virida-staging
    depends_on:
      - backend-api-gateway
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  frontend-dashboard:
    image: virida/dashboard:staging
    container_name: virida-dashboard-staging
    environment:
      - NODE_ENV=staging
      - REACT_APP_API_URL=https://staging-api.virida.com/api
    ports:
      - "3001:3000"
    networks:
      - virida-staging
    depends_on:
      - backend-api-gateway
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ========================================
  # BACKEND SERVICES
  # ========================================
  backend-api-gateway:
    image: virida/api-gateway:staging
    container_name: virida-api-gateway-staging
    environment:
      - NODE_ENV=staging
      - PORT=8080
      - DATABASE_URL=${STAGING_DATABASE_URL}
      - REDIS_URL=${STAGING_REDIS_URL}
      - JWT_SECRET=${STAGING_JWT_SECRET}
      - LOG_LEVEL=info
    ports:
      - "8080:8080"
    networks:
      - virida-staging
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  backend-auth-service:
    image: virida/auth-service:staging
    container_name: virida-auth-staging
    environment:
      - NODE_ENV=staging
      - PORT=8081
      - DATABASE_URL=${STAGING_DATABASE_URL}
      - JWT_SECRET=${STAGING_JWT_SECRET}
      - LOG_LEVEL=info
    ports:
      - "8081:8081"
    networks:
      - virida-staging
    depends_on:
      - postgres
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ========================================
  # AI/ML SERVICES
  # ========================================
  ai-prediction-engine:
    image: virida/prediction-engine:staging
    container_name: virida-prediction-staging
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8000
      - DATABASE_URL=${STAGING_DATABASE_URL}
      - MODEL_PATH=/app/models
      - LOG_LEVEL=info
    ports:
      - "8000:8000"
    volumes:
      - prediction_models:/app/models
    networks:
      - virida-staging
    depends_on:
      - postgres
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  ai-eve-assistant:
    image: virida/eve-assistant:staging
    container_name: virida-eve-staging
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8001
      - DATABASE_URL=${STAGING_DATABASE_URL}
      - LOG_LEVEL=info
    ports:
      - "8001:8001"
    networks:
      - virida-staging
    depends_on:
      - postgres
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  # ========================================
  # IOT SERVICES
  # ========================================
  iot-sensor-collector:
    image: virida/sensor-collector:staging
    container_name: virida-sensor-staging
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=9000
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
      - DATABASE_URL=${STAGING_DATABASE_URL}
      - LOG_LEVEL=info
    ports:
      - "9000:9000"
    networks:
      - virida-staging
    depends_on:
      - mqtt-broker
      - postgres
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  mqtt-broker:
    image: eclipse-mosquitto:2.0
    container_name: virida-mqtt-staging
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto-staging.conf:/mosquitto/config/mosquitto.conf
    networks:
      - virida-staging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'

  # ========================================
  # DATABASE SERVICES
  # ========================================
  postgres:
    image: postgres:15-alpine
    container_name: virida-postgres-staging
    environment:
      - POSTGRES_DB=${STAGING_POSTGRES_DB}
      - POSTGRES_USER=${STAGING_POSTGRES_USER}
      - POSTGRES_PASSWORD=${STAGING_POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_staging_data:/var/lib/postgresql/data
      - ./init-db-staging.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - virida-staging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'

  redis:
    image: redis:7-alpine
    container_name: virida-redis-staging
    ports:
      - "6379:6379"
    volumes:
      - redis_staging_data:/data
    networks:
      - virida-staging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  # ========================================
  # MONITORING SERVICES
  # ========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: virida-prometheus-staging
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus-staging.yml:/etc/prometheus/prometheus.yml
      - prometheus_staging_data:/prometheus
    networks:
      - virida-staging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  grafana:
    image: grafana/grafana:latest
    container_name: virida-grafana-staging
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${STAGING_GRAFANA_PASSWORD}
      - GF_SERVER_DOMAIN=staging-grafana.virida.com
    ports:
      - "3002:3000"
    volumes:
      - grafana_staging_data:/var/lib/grafana
    networks:
      - virida-staging
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

# ========================================
# NETWORKS
# ========================================
networks:
  virida-staging:
    driver: bridge
    name: virida-staging-network

# ========================================
# VOLUMES
# ========================================
volumes:
  postgres_staging_data:
    driver: local
  redis_staging_data:
    driver: local
  prometheus_staging_data:
    driver: local
  grafana_staging_data:
    driver: local
  prediction_models:
    driver: local
