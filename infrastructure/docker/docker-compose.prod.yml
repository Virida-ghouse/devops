# ðŸš€ VIRIDA Production Environment
# Configuration Docker Compose pour l'environnement de production

version: '3.8'

services:
  # ========================================
  # FRONTEND SERVICES
  # ========================================
  frontend-3d:
    image: virida/3d-visualizer:latest
    container_name: virida-3d-prod
    environment:
      - NODE_ENV=production
      - REACT_APP_API_URL=https://api.virida.com/api
      - REACT_APP_3D_ENGINE=threejs
    ports:
      - "3000:3000"
    networks:
      - virida-prod
    depends_on:
      - backend-api-gateway
    restart: always
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  frontend-dashboard:
    image: virida/dashboard:latest
    container_name: virida-dashboard-prod
    environment:
      - NODE_ENV=production
      - REACT_APP_API_URL=https://api.virida.com/api
    ports:
      - "3001:3000"
    networks:
      - virida-prod
    depends_on:
      - backend-api-gateway
    restart: always
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  # ========================================
  # BACKEND SERVICES
  # ========================================
  backend-api-gateway:
    image: virida/api-gateway:latest
    container_name: virida-api-gateway-prod
    environment:
      - NODE_ENV=production
      - PORT=8080
      - DATABASE_URL=${PROD_DATABASE_URL}
      - REDIS_URL=${PROD_REDIS_URL}
      - JWT_SECRET=${PROD_JWT_SECRET}
      - LOG_LEVEL=warn
    ports:
      - "8080:8080"
    networks:
      - virida-prod
    depends_on:
      - postgres
      - redis
    restart: always
    deploy:
      replicas: 3
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  backend-auth-service:
    image: virida/auth-service:latest
    container_name: virida-auth-prod
    environment:
      - NODE_ENV=production
      - PORT=8081
      - DATABASE_URL=${PROD_DATABASE_URL}
      - JWT_SECRET=${PROD_JWT_SECRET}
      - LOG_LEVEL=warn
    ports:
      - "8081:8081"
    networks:
      - virida-prod
    depends_on:
      - postgres
    restart: always
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  # ========================================
  # AI/ML SERVICES
  # ========================================
  ai-prediction-engine:
    image: virida/prediction-engine:latest
    container_name: virida-prediction-prod
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8000
      - DATABASE_URL=${PROD_DATABASE_URL}
      - MODEL_PATH=/app/models
      - LOG_LEVEL=warn
    ports:
      - "8000:8000"
    volumes:
      - prediction_models:/app/models
    networks:
      - virida-prod
    depends_on:
      - postgres
    restart: always
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 4G
          cpus: '4.0'
        reservations:
          memory: 2G
          cpus: '2.0'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  ai-eve-assistant:
    image: virida/eve-assistant:latest
    container_name: virida-eve-prod
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8001
      - DATABASE_URL=${PROD_DATABASE_URL}
      - LOG_LEVEL=warn
    ports:
      - "8001:8001"
    networks:
      - virida-prod
    depends_on:
      - postgres
    restart: always
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  # ========================================
  # IOT SERVICES
  # ========================================
  iot-sensor-collector:
    image: virida/sensor-collector:latest
    container_name: virida-sensor-prod
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=9000
      - MQTT_BROKER=mqtt-broker
      - MQTT_PORT=1883
      - DATABASE_URL=${PROD_DATABASE_URL}
      - LOG_LEVEL=warn
    ports:
      - "9000:9000"
    networks:
      - virida-prod
    depends_on:
      - mqtt-broker
      - postgres
    restart: always
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  mqtt-broker:
    image: eclipse-mosquitto:2.0
    container_name: virida-mqtt-prod
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto-prod.conf:/mosquitto/config/mosquitto.conf
    networks:
      - virida-prod
    restart: always
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  # ========================================
  # DATABASE SERVICES
  # ========================================
  postgres:
    image: postgres:15-alpine
    container_name: virida-postgres-prod
    environment:
      - POSTGRES_DB=${PROD_POSTGRES_DB}
      - POSTGRES_USER=${PROD_POSTGRES_USER}
      - POSTGRES_PASSWORD=${PROD_POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
      - ./init-db-prod.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - virida-prod
    restart: always
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 4G
          cpus: '4.0'
        reservations:
          memory: 2G
          cpus: '2.0'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  redis:
    image: redis:7-alpine
    container_name: virida-redis-prod
    ports:
      - "6379:6379"
    volumes:
      - redis_prod_data:/data
    networks:
      - virida-prod
    restart: always
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  # ========================================
  # MONITORING SERVICES
  # ========================================
  prometheus:
    image: prom/prometheus:latest
    container_name: virida-prometheus-prod
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus-prod.yml:/etc/prometheus/prometheus.yml
      - prometheus_prod_data:/prometheus
    networks:
      - virida-prod
    restart: always
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  grafana:
    image: grafana/grafana:latest
    container_name: virida-grafana-prod
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${PROD_GRAFANA_PASSWORD}
      - GF_SERVER_DOMAIN=grafana.virida.com
    ports:
      - "3002:3000"
    volumes:
      - grafana_prod_data:/var/lib/grafana
    networks:
      - virida-prod
    restart: always
    deploy:
      replicas: 1
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

# ========================================
# NETWORKS
# ========================================
networks:
  virida-prod:
    driver: bridge
    name: virida-prod-network

# ========================================
# VOLUMES
# ========================================
volumes:
  postgres_prod_data:
    driver: local
  redis_prod_data:
    driver: local
  prometheus_prod_data:
    driver: local
  grafana_prod_data:
    driver: local
  prediction_models:
    driver: local
