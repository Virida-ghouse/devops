pipeline {
    agent {
        kubernetes {
            label 'jenkins-agent'
            yaml '''
                apiVersion: v1
                kind: Pod
                spec:
                  containers:
                  - name: node
                    image: node:18-alpine
                    command:
                    - cat
                    tty: true
                    volumeMounts:
                    - name: workspace-volume
                      mountPath: /home/jenkins/agent
                  - name: docker
                    image: docker:latest
                    command:
                    - cat
                    tty: true
                    securityContext:
                      privileged: true
                    volumeMounts:
                    - name: docker-sock
                      mountPath: /var/run/docker.sock
                  volumes:
                  - name: workspace-volume
                    emptyDir: {}
                  - name: docker-sock
                    hostPath:
                      path: /var/run/docker.sock
            '''
        }
    }
    
    environment {
        // Configuration VIRIDA
        PROJECT_NAME = 'frontend-3d-visualizer'
        DOCKER_REGISTRY = 'registry.virida.local'
        DOCKER_IMAGE = "${DOCKER_REGISTRY}/virida/${PROJECT_NAME}"
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        
        // Configuration Kubernetes
        K8S_NAMESPACE = 'virida-apps'
        K8S_MANIFEST_PATH = 'k8s/'
        
        // Configuration des tests
        NODE_ENV = 'test'
        COVERAGE_THRESHOLD = '80'
        
        // Configuration des notifications
        SLACK_CHANNEL = '#virida-dev'
        TEAM_EMAIL = 'dev@virida.local'
    }
    
    options {
        // Options du pipeline
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
        ansiColor('xterm')
    }
    
    triggers {
        // D√©clencheurs automatiques
        pollSCM('H/5 * * * *')  // Poll toutes les 5 minutes
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout du code depuis Gitea
                    checkout([
                        $class: 'GitSCM',
                        branches: [[name: '*/main']],
                        userRemoteConfigs: [[
                            url: 'https://gitea.virida.local/frontend/3d-visualizer.git',
                            credentialsId: 'gitea-credentials'
                        ]],
                        extensions: [
                            [$class: 'CleanBeforeCheckout'],
                            [$class: 'SubmoduleOption', recursiveSubmodules: true]
                        ]
                    ])
                    
                    // R√©cup√©ration des informations Git
                    env.GIT_COMMIT_SHORT = sh(
                        script: 'git rev-parse --short HEAD',
                        returnStdout: true
                    ).trim()
                    
                    env.GIT_BRANCH = sh(
                        script: 'git rev-parse --abbrev-ref HEAD',
                        returnStdout: true
                    ).trim()
                    
                    env.GIT_COMMIT_MSG = sh(
                        script: 'git log -1 --pretty=%B',
                        returnStdout: true
                    ).trim()
                }
                
                // Affichage des informations
                echo "Build #${env.BUILD_NUMBER} - ${env.PROJECT_NAME}"
                echo "Branch: ${env.GIT_BRANCH}"
                echo "Commit: ${env.GIT_COMMIT_SHORT}"
                echo "Message: ${env.GIT_COMMIT_MSG}"
            }
        }
        
        stage('Install Dependencies') {
            steps {
                container('node') {
                    script {
                        // Installation des d√©pendances Node.js
                        sh '''
                            echo "Installing Node.js dependencies..."
                            npm ci --prefer-offline --no-audit
                            
                            echo "Installing additional tools..."
                            npm install -g @next/codemod
                            npm install -g eslint
                            npm install -g prettier
                        '''
                        
                        // V√©rification des vuln√©rabilit√©s
                        sh '''
                            echo "Checking for security vulnerabilities..."
                            npm audit --audit-level=moderate || true
                        '''
                    }
                }
            }
        }
        
        stage('Code Quality') {
            parallel {
                stage('Linting') {
                    steps {
                        container('node') {
                            script {
                                sh '''
                                    echo "Running ESLint..."
                                    npm run lint
                                    
                                    echo "Running Prettier check..."
                                    npm run format:check
                                '''
                            }
                        }
                    }
                }
                
                stage('Type Checking') {
                    steps {
                        container('node') {
                            script {
                                sh '''
                                    echo "Running TypeScript type checking..."
                                    npm run type-check
                                '''
                            }
                        }
                    }
                }
                
                stage('Security Scan') {
                    steps {
                        container('node') {
                            script {
                                sh '''
                                    echo "Running security scan with npm audit..."
                                    npm audit --audit-level=high || true
                                    
                                    echo "Running Snyk security scan..."
                                    npx snyk test --severity-threshold=high || true
                                '''
                            }
                        }
                    }
                }
            }
        }
        
        stage('Testing') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        container('node') {
                            script {
                                sh '''
                                    echo "Running unit tests..."
                                    npm run test:unit -- --coverage --watchAll=false
                                '''
                                
                                // Publication des r√©sultats de tests
                                publishTestResults testResultsPattern: 'coverage/lcov.info'
                                publishCoverage adapters: [lcovAdapter('coverage/lcov.info')]
                            }
                        }
                    }
                }
                
                stage('Integration Tests') {
                    steps {
                        container('node') {
                            script {
                                sh '''
                                    echo "Running integration tests..."
                                    npm run test:integration -- --watchAll=false
                                '''
                            }
                        }
                    }
                }
                
                stage('E2E Tests') {
                    steps {
                        container('node') {
                            script {
                                sh '''
                                    echo "Running end-to-end tests..."
                                    npm run test:e2e -- --watchAll=false
                                '''
                            }
                        }
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                container('node') {
                    script {
                        // Build de l'application
                        sh '''
                            echo "Building application..."
                            npm run build
                            
                            echo "Building for production..."
                            npm run build:prod
                        '''
                        
                        // V√©rification de la taille du bundle
                        sh '''
                            echo "Analyzing bundle size..."
                            npm run analyze
                        '''
                    }
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                container('docker') {
                    script {
                        // Build de l'image Docker
                        sh '''
                            echo "Building Docker image..."
                            docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                            docker build -t ${DOCKER_IMAGE}:latest .
                            
                            echo "Tagging images..."
                            docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:${env.GIT_COMMIT_SHORT}
                            docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:${env.GIT_BRANCH}
                        '''
                        
                        // Scan de s√©curit√© de l'image
                        sh '''
                            echo "Scanning Docker image for vulnerabilities..."
                            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                                aquasec/trivy image ${DOCKER_IMAGE}:${DOCKER_TAG} \
                                --severity HIGH,CRITICAL --exit-code 1 || true
                        '''
                    }
                }
            }
        }
        
        stage('Push to Registry') {
            steps {
                container('docker') {
                    script {
                        // Push vers le registry priv√©
                        sh '''
                            echo "Pushing Docker images to registry..."
                            docker push ${DOCKER_IMAGE}:${DOCKER_TAG}
                            docker push ${DOCKER_IMAGE}:latest
                            docker push ${DOCKER_IMAGE}:${env.GIT_COMMIT_SHORT}
                            docker push ${DOCKER_IMAGE}:${env.GIT_BRANCH}
                        '''
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                container('docker') {
                    script {
                        // D√©ploiement sur Kubernetes
                        sh '''
                            echo "Deploying to Kubernetes..."
                            
                            # Mise √† jour de l'image dans le manifest
                            sed -i "s|image: .*|image: ${DOCKER_IMAGE}:${DOCKER_TAG}|g" ${K8S_MANIFEST_PATH}/deployment.yaml
                            
                            # Application du manifest
                            kubectl apply -f ${K8S_MANIFEST_PATH}/ -n ${K8S_NAMESPACE}
                            
                            # V√©rification du d√©ploiement
                            kubectl rollout status deployment/${PROJECT_NAME} -n ${K8S_NAMESPACE} --timeout=300s
                        '''
                        
                        // V√©rification de la sant√© du service
                        sh '''
                            echo "Checking service health..."
                            kubectl get pods -n ${K8S_NAMESPACE} -l app=${PROJECT_NAME}
                            
                            # Test de connectivit√©
                            kubectl run test-${PROJECT_NAME} --image=curlimages/curl --rm -i --restart=Never \
                                -- curl -f http://${PROJECT_NAME}:3000/health || true
                        '''
                    }
                }
            }
        }
        
        stage('Integration Tests') {
            steps {
                container('node') {
                    script {
                        // Tests d'int√©gration apr√®s d√©ploiement
                        sh '''
                            echo "Running post-deployment integration tests..."
                            npm run test:post-deploy
                        '''
                    }
                }
            }
        }
        
        stage('Performance Tests') {
            steps {
                container('node') {
                    script {
                        // Tests de performance
                        sh '''
                            echo "Running performance tests..."
                            npm run test:performance
                        '''
                        
                        // Lighthouse audit
                        sh '''
                            echo "Running Lighthouse audit..."
                            npx lighthouse http://${PROJECT_NAME}.virida.local \
                                --output=json --output-path=./lighthouse-report.json
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            // Nettoyage
            script {
                // Nettoyage des images Docker locales
                sh '''
                    echo "Cleaning up local Docker images..."
                    docker rmi ${DOCKER_IMAGE}:${DOCKER_TAG} || true
                    docker rmi ${DOCKER_IMAGE}:latest || true
                    docker system prune -f || true
                '''
                
                // Nettoyage des workspaces Kubernetes
                sh '''
                    echo "Cleaning up Kubernetes test pods..."
                    kubectl delete pod test-${PROJECT_NAME} -n ${K8S_NAMESPACE} || true
                '''
            }
            
            // Publication des artefacts
            archiveArtifacts artifacts: '**/build/**/*, **/coverage/**/*, **/lighthouse-report.json', fingerprint: true
            
            // Publication des rapports
            publishTestResults testResultsPattern: '**/test-results.xml'
            publishCoverage adapters: [lcovAdapter('coverage/lcov.info')]
        }
        
        success {
            script {
                // Notifications de succ√®s
                echo "Build successful! üéâ"
                
                // Notification Slack
                slackSend(
                    channel: env.SLACK_CHANNEL,
                    color: 'good',
                    message: "‚úÖ Build successful: ${env.PROJECT_NAME} #${env.BUILD_NUMBER}\n" +
                            "Branch: ${env.GIT_BRANCH}\n" +
                            "Commit: ${env.GIT_COMMIT_SHORT}\n" +
                            "Deployed to: ${env.K8S_NAMESPACE}"
                )
                
                // Notification email
                emailext(
                    subject: "‚úÖ VIRIDA Build Successful: ${env.PROJECT_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        Build successful for ${env.PROJECT_NAME}
                        
                        Details:
                        - Build Number: ${env.BUILD_NUMBER}
                        - Branch: ${env.GIT_BRANCH}
                        - Commit: ${env.GIT_COMMIT_SHORT}
                        - Deployed to: ${env.K8S_NAMESPACE}
                        - Build URL: ${env.BUILD_URL}
                        
                        VIRIDA DevOps Team
                    """,
                    to: env.TEAM_EMAIL
                )
            }
        }
        
        failure {
            script {
                // Notifications d'√©chec
                echo "Build failed! ‚ùå"
                
                // Notification Slack
                slackSend(
                    channel: env.SLACK_CHANNEL,
                    color: 'danger',
                    message: "‚ùå Build failed: ${env.PROJECT_NAME} #${env.BUILD_NUMBER}\n" +
                            "Branch: ${env.GIT_BRANCH}\n" +
                            "Commit: ${env.GIT_COMMIT_SHORT}\n" +
                            "Build URL: ${env.BUILD_URL}"
                )
                
                // Notification email
                emailext(
                    subject: "‚ùå VIRIDA Build Failed: ${env.PROJECT_NAME} #${env.BUILD_NUMBER}",
                    body: """
                        Build failed for ${env.PROJECT_NAME}
                        
                        Details:
                        - Build Number: ${env.BUILD_NUMBER}
                        - Branch: ${env.GIT_BRANCH}
                        - Commit: ${env.GIT_COMMIT_SHORT}
                        - Build URL: ${env.BUILD_URL}
                        
                        Please check the build logs for details.
                        
                        VIRIDA DevOps Team
                    """,
                    to: env.TEAM_EMAIL
                )
            }
        }
        
        cleanup {
            // Nettoyage final
            script {
                echo "Cleaning up workspace..."
                cleanWs()
            }
        }
    }
}

