# Dockerfile pour Gitea Runner VIRIDA
FROM ubuntu:22.04

# Variables d'environnement
ENV DEBIAN_FRONTEND=noninteractive
ENV ACT_RUNNER_VERSION=0.2.13
ENV GITEA_INSTANCE_URL=""
ENV RUNNER_NAME="virida-runner"
ENV RUNNER_LABELS="ubuntu-latest:docker://node:18,ubuntu-latest:docker://python:3.11,ubuntu-latest:docker://golang:1.21"

# Installer les d√©pendances syst√®me
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    git \
    docker.io \
    docker-compose \
    build-essential \
    ca-certificates \
    gnupg \
    lsb-release \
    software-properties-common \
    && rm -rf /var/lib/apt/lists/*

# Installer Node.js 18
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs

# Installer Python 3.11
RUN add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y python3.11 python3.11-pip python3.11-venv \
    && ln -s /usr/bin/python3.11 /usr/bin/python3 \
    && ln -s /usr/bin/python3.11 /usr/bin/python

# Installer Go 1.21
RUN wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz \
    && tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz \
    && rm go1.21.0.linux-amd64.tar.gz
ENV PATH="/usr/local/go/bin:${PATH}"

# Installer Clever Cloud CLI
RUN curl -fsSL https://clever-tools.clever-cloud.com/releases/2.7.0/clever-tools-linux.tar.gz | tar -xz \
    && mv clever /usr/local/bin/ \
    && chmod +x /usr/local/bin/clever

# Cr√©er un utilisateur pour le runner
RUN useradd -m -s /bin/bash runner \
    && usermod -aG docker runner

# Cr√©er le r√©pertoire de travail
WORKDIR /opt/gitea-runner
RUN chown -R runner:runner /opt/gitea-runner

# T√©l√©charger et installer act_runner
RUN wget https://gitea.com/gitea/act_runner/releases/download/v${ACT_RUNNER_VERSION}/act_runner-${ACT_RUNNER_VERSION}-linux-amd64.tar.gz \
    && tar -xzf act_runner-${ACT_RUNNER_VERSION}-linux-amd64.tar.gz \
    && chmod +x act_runner \
    && mv act_runner /usr/local/bin/ \
    && rm act_runner-${ACT_RUNNER_VERSION}-linux-amd64.tar.gz

# Copier les scripts
COPY scripts/start-gitea-runner.sh /usr/local/bin/start-gitea-runner.sh
RUN chmod +x /usr/local/bin/start-gitea-runner.sh

# Cr√©er le r√©pertoire de configuration
RUN mkdir -p /opt/gitea-runner/.runner

# Exposer le port (si n√©cessaire)
EXPOSE 8080

# Script de d√©marrage
COPY <<EOF /usr/local/bin/entrypoint.sh
#!/bin/bash
set -e

echo "üöÄ D√©marrage du Gitea Runner VIRIDA"
echo "===================================="

# V√©rifier les variables d'environnement
if [ -z "\$GITEA_INSTANCE_URL" ]; then
    echo "‚ùå GITEA_INSTANCE_URL n'est pas d√©finie"
    exit 1
fi

if [ -z "\$RUNNER_NAME" ]; then
    echo "‚ùå RUNNER_NAME n'est pas d√©finie"
    exit 1
fi

echo "Instance Gitea: \$GITEA_INSTANCE_URL"
echo "Nom du runner: \$RUNNER_NAME"
echo "Labels: \$RUNNER_LABELS"
echo ""

# D√©marrer Docker si n√©cessaire
if ! docker info &> /dev/null; then
    echo "D√©marrage de Docker..."
    service docker start
    sleep 5
fi

# V√©rifier si le runner est d√©j√† enregistr√©
if [ ! -f "/opt/gitea-runner/.runner" ]; then
    echo "‚ö†Ô∏è  Le runner n'est pas enregistr√©"
    echo "Vous devez d'abord l'enregistrer avec :"
    echo "act_runner register --instance \$GITEA_INSTANCE_URL --token YOUR_TOKEN --name \$RUNNER_NAME --labels \"\$RUNNER_LABELS\""
    echo ""
    echo "Pour obtenir le token :"
    echo "1. Allez sur \$GITEA_INSTANCE_URL/admin/actions/runners"
    echo "2. Cr√©ez un nouveau runner"
    echo "3. Copiez le token d'enregistrement"
    echo ""
    echo "En attendant, le runner va essayer de se connecter..."
fi

# D√©marrer act_runner
echo "D√©marrage d'act_runner..."
exec act_runner daemon
EOF

RUN chmod +x /usr/local/bin/entrypoint.sh

# Changer vers l'utilisateur runner
USER runner

# Point d'entr√©e
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]