# üöÄ VIRIDA Makefile - Optimis√© pour Clever Cloud
# Commandes simplifi√©es pour le d√©ploiement sur Clever Cloud

.PHONY: help build deploy status logs clean

# Variables
CLEVER_APP_NAME=virida
CLEVER_ORG_ID=orga_a7844a87-3356-462b-9e22-ce6c5437b0aa

# Couleurs
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

# Aide
help: ## Afficher l'aide
	@echo "$(BLUE)üöÄ VIRIDA - Commandes Clever Cloud$(NC)"
	@echo ""
	@echo "$(GREEN)Commandes Clever Cloud:$(NC)"
	@echo "  build     - Construire l'image Docker optimis√©e"
	@echo "  deploy    - D√©ployer sur Clever Cloud"
	@echo "  status    - Voir le statut de l'application"
	@echo "  logs      - Voir les logs de l'application"
	@echo "  clean     - Nettoyer les ressources locales"
	@echo ""
	@echo "$(GREEN)Exemples:$(NC)"
	@echo "  make build    - Construire l'image"
	@echo "  make deploy   - D√©ployer sur Clever Cloud"
	@echo "  make status   - Voir le statut"
	@echo ""

# ========================================
# CONSTRUCTION ET D√âPLOIEMENT
# ========================================
build: ## Construire l'image Docker optimis√©e pour Clever Cloud
	@echo "$(BLUE)üî® Construction de l'image Docker optimis√©e...$(NC)"
	@docker build -f Dockerfile.clever -t $(CLEVER_APP_NAME):latest .
	@docker tag $(CLEVER_APP_NAME):latest $(CLEVER_APP_NAME):clever
	@echo "$(GREEN)‚úÖ Image construite avec succ√®s$(NC)"

deploy: ## D√©ployer sur Clever Cloud
	@echo "$(BLUE)‚òÅÔ∏è  D√©ploiement sur Clever Cloud...$(NC)"
	@clever deploy --app $(CLEVER_APP_NAME)
	@echo "$(GREEN)‚úÖ D√©ploiement termin√© avec succ√®s$(NC)"

build-and-deploy: ## Construire et d√©ployer en une commande
	@echo "$(BLUE)üöÄ Construction et d√©ploiement sur Clever Cloud...$(NC)"
	@make build
	@make deploy
	@echo "$(GREEN)‚úÖ Construction et d√©ploiement termin√©s$(NC)"

# ========================================
# MONITORING ET LOGS
# ========================================
status: ## Voir le statut de l'application Clever Cloud
	@echo "$(BLUE)üìä Statut de l'application Clever Cloud...$(NC)"
	@clever status --app $(CLEVER_APP_NAME)

logs: ## Voir les logs de l'application Clever Cloud
	@echo "$(BLUE)üìã Logs de l'application Clever Cloud...$(NC)"
	@clever logs --app $(CLEVER_APP_NAME)

logs-follow: ## Suivre les logs en temps r√©el
	@echo "$(BLUE)üìã Suivi des logs en temps r√©el...$(NC)"
	@clever logs --app $(CLEVER_APP_NAME) --follow

# ========================================
# GESTION DES VARIABLES D'ENVIRONNEMENT
# ========================================
env-list: ## Lister les variables d'environnement
	@echo "$(BLUE)üîß Variables d'environnement Clever Cloud...$(NC)"
	@clever env --app $(CLEVER_APP_NAME)

env-set: ## D√©finir une variable d'environnement (usage: make env-set KEY=value)
	@echo "$(BLUE)üîß D√©finition de la variable d'environnement...$(NC)"
	@clever env set $(KEY) $(VALUE) --app $(CLEVER_APP_NAME)
	@echo "$(GREEN)‚úÖ Variable $(KEY) d√©finie$(NC)"

env-unset: ## Supprimer une variable d'environnement (usage: make env-unset KEY=key)
	@echo "$(BLUE)üîß Suppression de la variable d'environnement...$(NC)"
	@clever env unset $(KEY) --app $(CLEVER_APP_NAME)
	@echo "$(GREEN)‚úÖ Variable $(KEY) supprim√©e$(NC)"

# ========================================
# GESTION DES DOMAINES
# ========================================
domain-list: ## Lister les domaines
	@echo "$(BLUE)üåê Domaines de l'application...$(NC)"
	@clever domain --app $(CLEVER_APP_NAME)

domain-add: ## Ajouter un domaine (usage: make domain-add DOMAIN=example.com)
	@echo "$(BLUE)üåê Ajout du domaine...$(NC)"
	@clever domain add $(DOMAIN) --app $(CLEVER_APP_NAME)
	@echo "$(GREEN)‚úÖ Domaine $(DOMAIN) ajout√©$(NC)"

domain-remove: ## Supprimer un domaine (usage: make domain-remove DOMAIN=example.com)
	@echo "$(BLUE)üåê Suppression du domaine...$(NC)"
	@clever domain remove $(DOMAIN) --app $(CLEVER_APP_NAME)
	@echo "$(GREEN)‚úÖ Domaine $(DOMAIN) supprim√©$(NC)"

# ========================================
# GESTION DES ADDONS
# ========================================
addon-list: ## Lister les addons
	@echo "$(BLUE)üîå Addons de l'application...$(NC)"
	@clever addon --app $(CLEVER_APP_NAME)

addon-create: ## Cr√©er un addon (usage: make addon-create ADDON=postgresql)
	@echo "$(BLUE)üîå Cr√©ation de l'addon...$(NC)"
	@clever addon create $(ADDON) --app $(CLEVER_APP_NAME)
	@echo "$(GREEN)‚úÖ Addon $(ADDON) cr√©√©$(NC)"

# ========================================
# MAINTENANCE
# ========================================
clean: ## Nettoyer les ressources locales
	@echo "$(RED)üßπ Nettoyage des ressources locales...$(NC)"
	@docker rmi $(CLEVER_APP_NAME):latest 2>/dev/null || true
	@docker rmi $(CLEVER_APP_NAME):clever 2>/dev/null || true
	@docker system prune -f
	@echo "$(GREEN)‚úÖ Ressources nettoy√©es$(NC)"

restart: ## Red√©marrer l'application Clever Cloud
	@echo "$(BLUE)üîÑ Red√©marrage de l'application...$(NC)"
	@clever restart --app $(CLEVER_APP_NAME)
	@echo "$(GREEN)‚úÖ Application red√©marr√©e$(NC)"

# ========================================
# INFORMATIONS
# ========================================
info: ## Afficher les informations de l'application
	@echo "$(BLUE)‚ÑπÔ∏è  Informations de l'application VIRIDA$(NC)"
	@echo ""
	@echo "$(GREEN)Application:$(NC) $(CLEVER_APP_NAME)"
	@echo "$(GREEN)Organisation:$(NC) $(CLEVER_ORG_ID)"
	@echo "$(GREEN)Plateforme:$(NC) Clever Cloud"
	@echo "$(GREEN)Version:$(NC) 1.0.0"
	@echo ""
	@echo "$(GREEN)Commandes utiles:$(NC)"
	@echo "  make build-and-deploy  - Construction et d√©ploiement"
	@echo "  make status            - Statut de l'application"
	@echo "  make logs              - Voir les logs"
	@echo "  make env-list          - Variables d'environnement"

# ========================================
# D√âVELOPPEMENT RAPIDE
# ========================================
quick-deploy: ## D√©ploiement rapide (build + deploy + status)
	@echo "$(BLUE)‚ö° D√©ploiement rapide sur Clever Cloud...$(NC)"
	@make build
	@make deploy
	@sleep 5
	@make status
	@echo "$(GREEN)‚úÖ D√©ploiement rapide termin√©$(NC)"

# ========================================
# S√âCURIT√â
# ========================================
security-scan: ## Scanner l'image Docker pour les vuln√©rabilit√©s
	@echo "$(BLUE)üîí Scan de s√©curit√© de l'image Docker...$(NC)"
	@docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image $(CLEVER_APP_NAME):latest
	@echo "$(GREEN)‚úÖ Scan de s√©curit√© termin√©$(NC)"

# ========================================
# BACKUP ET RESTAURATION
# ========================================
backup-env: ## Sauvegarder les variables d'environnement
	@echo "$(BLUE)üíæ Sauvegarde des variables d'environnement...$(NC)"
	@clever env --app $(CLEVER_APP_NAME) > backup-env-$(shell date +%Y%m%d_%H%M%S).txt
	@echo "$(GREEN)‚úÖ Variables d'environnement sauvegard√©es$(NC)"

# ========================================
# COMMANDES DE D√âVELOPPEMENT
# ========================================
dev-setup: ## Configuration initiale pour le d√©veloppement
	@echo "$(BLUE)‚öôÔ∏è  Configuration initiale...$(NC)"
	@clever login
	@clever link --app $(CLEVER_APP_NAME)
	@echo "$(GREEN)‚úÖ Configuration initiale termin√©e$(NC)"

dev-test: ## Tester l'application localement
	@echo "$(BLUE)üß™ Test de l'application locale...$(NC)"
	@docker run --rm -p 8080:8080 $(CLEVER_APP_NAME):latest &
	@sleep 5
	@curl -f http://localhost:8080/health || exit 1
	@docker stop $$(docker ps -q --filter ancestor=$(CLEVER_APP_NAME):latest)
	@echo "$(GREEN)‚úÖ Test local r√©ussi$(NC)"
