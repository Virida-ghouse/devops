name: ğŸ” PR Validation & Review

on:
  pull_request:
    branches: [ main, staging ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ========================================
  # VALIDATION DES PULL REQUESTS
  # ========================================
  pr-validation:
    name: ğŸ” PR Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-3d/package-lock.json

      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: apps/ai-ml/requirements.txt

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/frontend-3d && npm ci
          cd ../ai-ml && pip install -r requirements.txt

      - name: ğŸ§ª Run Tests
        run: |
          cd apps/frontend-3d && npm run test
          cd ../ai-ml && python -m pytest tests/ -v

      - name: ğŸ” Code Quality Check
        run: |
          cd apps/frontend-3d && npm run lint
          cd ../ai-ml && python -m pylint app/

      - name: ğŸ”’ Security Scan
        uses: securecodewarrior/docker-security-scan@v1
        with:
          path: apps/

      - name: ğŸ“Š Code Coverage
        run: |
          cd apps/frontend-3d && npm run test:coverage
          cd ../ai-ml && python -m pytest tests/ --cov=app --cov-report=xml

      - name: ğŸ“¤ Upload Coverage Reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            apps/frontend-3d/coverage/
            apps/ai-ml/coverage.xml
          retention-days: 7

  # ========================================
  # ANALYSE DE CODE AVANCÃ‰E
  # ========================================
  code-analysis:
    name: ğŸ”¬ Advanced Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Analysis Tools
        run: |
          npm install -g eslint-plugin-security
          pip install bandit safety

      - name: ğŸ” Security Analysis
        run: |
          cd apps/frontend-3d
          npm audit --audit-level moderate
          cd ../ai-ml
          bandit -r app/ -f json -o bandit-report.json
          safety check --json --output safety-report.json

      - name: ğŸ“Š Dependency Analysis
        run: |
          cd apps/frontend-3d
          npm outdated
          cd ../ai-ml
          pip list --outdated

      - name: ğŸ“¤ Upload Analysis Reports
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            apps/ai-ml/bandit-report.json
            apps/ai-ml/safety-report.json
          retention-days: 7

  # ========================================
  # BUILD DE VALIDATION
  # ========================================
  build-validation:
    name: ğŸ—ï¸ Build Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-3d/package-lock.json

      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/frontend-3d && npm ci
          cd ../ai-ml && pip install -r requirements.txt

      - name: ğŸ—ï¸ Build Applications
        run: |
          cd apps/frontend-3d && npm run build
          cd ../ai-ml && echo "Python app ready"

      - name: ğŸ“¦ Package Applications
        run: |
          cd apps/frontend-3d && tar -czf frontend-3d-pr.tar.gz dist/
          cd ../ai-ml && tar -czf ai-ml-pr.tar.gz app/ requirements.txt

      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-build-artifacts
          path: |
            apps/frontend-3d/frontend-3d-pr.tar.gz
            apps/ai-ml/ai-ml-pr.tar.gz
          retention-days: 3

  # ========================================
  # COMMENTAIRE DE PR
  # ========================================
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [pr-validation, code-analysis, build-validation]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ’¬ Create PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && comment.body.includes('ğŸ” PR Validation Results')
            );
            
            const validationStatus = '${{ needs.pr-validation.result }}';
            const analysisStatus = '${{ needs.code-analysis.result }}';
            const buildStatus = '${{ needs.build-validation.result }}';
            
            const getStatusIcon = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¹ï¸';
                default: return 'â³';
              }
            };
            
            const commentBody = `## ğŸ” PR Validation Results
            
            | Check | Status | Details |
            |-------|--------|---------|
            | Tests & Validation | ${getStatusIcon(validationStatus)} | ${{ needs.pr-validation.result }} |
            | Code Analysis | ${getStatusIcon(analysisStatus)} | ${{ needs.code-analysis.result }} |
            | Build Validation | ${getStatusIcon(buildStatus)} | ${{ needs.build-validation.result }} |
            
            ### ğŸ“Š Summary
            - **Branch**: \`${{ github.head_ref }}\`
            - **Target**: \`${{ github.base_ref }}\`
            - **Commit**: \`${{ github.sha }}\`
            - **Author**: @${{ github.actor }}
            
            ### ğŸš€ Next Steps
            ${validationStatus === 'success' && analysisStatus === 'success' && buildStatus === 'success' 
              ? 'âœ… All checks passed! This PR is ready for review and merge.' 
              : 'âš ï¸ Some checks failed. Please review the logs and fix the issues.'}
            
            ---
            *This comment was automatically generated by Gitea Actions*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }
