name: ğŸš€ Release Management

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ========================================
  # PRÃ‰PARATION DE LA RELEASE
  # ========================================
  prepare-release:
    name: ğŸ“‹ Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changelog: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Extract Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ Generate Changelog
        id: changelog
        run: |
          echo "## ğŸš€ Release ${{ steps.version.outputs.version }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ“… Date: $(date)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ”„ Changes:" >> CHANGELOG.md
          git log --oneline --since="1 month ago" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ§ª Tested Applications:" >> CHANGELOG.md
          echo "- Frontend 3D: https://virida-frontend-3d.cleverapps.io" >> CHANGELOG.md
          echo "- AI/ML: https://virida-ai-ml.cleverapps.io" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### ğŸ”— Links:" >> CHANGELOG.md
          echo "- Repository: https://gitea.com/Virida/devops" >> CHANGELOG.md
          echo "- Documentation: [CI-CD-SUMMARY.md](./CI-CD-SUMMARY.md)" >> CHANGELOG.md
          
          changelog_content=$(cat CHANGELOG.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¤ Upload Changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md
          retention-days: 30

  # ========================================
  # BUILD DE RELEASE
  # ========================================
  build-release:
    name: ğŸ—ï¸ Build Release
    runs-on: ubuntu-latest
    needs: prepare-release
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend-3d/package-lock.json

      - name: ğŸ”§ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd apps/frontend-3d && npm ci
          cd ../ai-ml && pip install -r requirements.txt

      - name: ğŸ—ï¸ Build Applications
        run: |
          cd apps/frontend-3d && npm run build
          cd ../ai-ml && echo "Python app ready"

      - name: ğŸ“¦ Package Release
        run: |
          mkdir -p release
          cd apps/frontend-3d
          tar -czf ../../release/frontend-3d-${{ needs.prepare-release.outputs.version }}.tar.gz dist/
          cd ../ai-ml
          tar -czf ../../release/ai-ml-${{ needs.prepare-release.outputs.version }}.tar.gz app/ requirements.txt
          
          # Create combined release package
          cd ../../release
          tar -czf virida-${{ needs.prepare-release.outputs.version }}.tar.gz *.tar.gz

      - name: ğŸ“¤ Upload Release Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ needs.prepare-release.outputs.version }}
          path: release/
          retention-days: 90

  # ========================================
  # DÃ‰PLOIEMENT DE RELEASE
  # ========================================
  deploy-release:
    name: ğŸš€ Deploy Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release]
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Release Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.prepare-release.outputs.version }}

      - name: ğŸ”§ Setup Clever Cloud CLI
        run: |
          npm install -g clever-tools

      - name: ğŸ” Login to Clever Cloud
        run: |
          clever login --token ${{ secrets.CLEVER_CLOUD_TOKEN }} --secret ${{ secrets.CLEVER_CLOUD_SECRET }}

      - name: ğŸš€ Deploy Frontend 3D
        run: |
          cd apps/frontend-3d
          clever deploy --alias virida-frontend-3d --same-commit-policy rebuild

      - name: ğŸš€ Deploy AI/ML
        run: |
          cd apps/ai-ml
          clever deploy --alias virida-ai-ml --same-commit-policy rebuild

      - name: ğŸ§ª Health Check Release
        run: |
          sleep 90
          curl -f https://virida-frontend-3d.cleverapps.io/health || exit 1
          curl -f https://virida-ai-ml.cleverapps.io/health || exit 1
          echo "âœ… Release deployment successful!"

  # ========================================
  # CRÃ‰ATION DE LA RELEASE
  # ========================================
  create-release:
    name: ğŸ“¦ Create Release
    runs-on: ubuntu-latest
    needs: [prepare-release, build-release, deploy-release]
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Release Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.prepare-release.outputs.version }}

      - name: ğŸ“¦ Create Release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.prepare-release.outputs.version }}
          release_name: VIRIDA ${{ needs.prepare-release.outputs.version }}
          body: |
            ${{ needs.prepare-release.outputs.changelog }}
            
            ## ğŸ“¦ Release Artifacts
            - `frontend-3d-${{ needs.prepare-release.outputs.version }}.tar.gz`
            - `ai-ml-${{ needs.prepare-release.outputs.version }}.tar.gz`
            - `virida-${{ needs.prepare-release.outputs.version }}.tar.gz` (combined)
            
            ## ğŸš€ Deployed Services
            - Frontend 3D: https://virida-frontend-3d.cleverapps.io
            - AI/ML: https://virida-ai-ml.cleverapps.io
            
            ## ğŸ”— Links
            - Repository: https://gitea.com/Virida/devops
            - Documentation: [CI-CD-SUMMARY.md](./CI-CD-SUMMARY.md)
          draft: false
          prerelease: false

      - name: ğŸ“¤ Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release/
          asset_name: virida-${{ needs.prepare-release.outputs.version }}.tar.gz
          asset_content_type: application/gzip

  # ========================================
  # NOTIFICATION DE RELEASE
  # ========================================
  notify-release:
    name: ğŸ“¢ Notify Release
    runs-on: ubuntu-latest
    needs: [create-release]
    
    steps:
      - name: ğŸ“¢ Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#releases'
          text: |
            ğŸ‰ **NEW RELEASE: VIRIDA ${{ needs.prepare-release.outputs.version }}**
            
            **ğŸš€ Deployed Services:**
            - Frontend 3D: https://virida-frontend-3d.cleverapps.io
            - AI/ML: https://virida-ai-ml.cleverapps.io
            
            **ğŸ“¦ Release Assets:**
            - Download: https://gitea.com/Virida/devops/releases/tag/${{ needs.prepare-release.outputs.version }}
            
            **ğŸ“ Changelog:**
            ${{ needs.prepare-release.outputs.changelog }}
            
            ---
            *Automated release by Gitea Actions*
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: ğŸ“§ Notify Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš€ VIRIDA Release ${{ needs.prepare-release.outputs.version }}"
          to: ${{ secrets.RELEASE_EMAIL_LIST }}
          from: VIRIDA CI/CD
          body: |
            A new release of VIRIDA has been deployed!
            
            Version: ${{ needs.prepare-release.outputs.version }}
            
            Services:
            - Frontend 3D: https://virida-frontend-3d.cleverapps.io
            - AI/ML: https://virida-ai-ml.cleverapps.io
            
            Download: https://gitea.com/Virida/devops/releases/tag/${{ needs.prepare-release.outputs.version }}
            
            Changelog:
            ${{ needs.prepare-release.outputs.changelog }}