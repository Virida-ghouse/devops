name: ğŸš€ Deploy VIRIDA to Clever Cloud

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ========================================
  # TESTS ET VALIDATION
  # ========================================
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: |
        cd frontend/3d-visualizer && npm ci
        cd ../dashboard && npm ci
        cd ../../backend/api-gateway && npm ci
        cd ../auth-service && npm ci
        
    - name: ğŸ§ª Run tests
      run: |
        cd frontend/3d-visualizer && npm test
        cd ../dashboard && npm test
        cd ../../backend/api-gateway && npm test
        cd ../auth-service && npm test
        
    - name: ğŸ” Lint code
      run: |
        cd frontend/3d-visualizer && npm run lint
        cd ../dashboard && npm run lint
        cd ../../backend/api-gateway && npm run lint
        cd ../auth-service && npm run lint

  # ========================================
  # BUILD ET DÃ‰PLOIEMENT
  # ========================================
  deploy:
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ğŸ“¦ Install Clever Tools
      run: |
        npm install -g clever-tools
        
    - name: ğŸ” Login to Clever Cloud
      run: |
        clever login --token ${{ secrets.CLEVER_CLOUD_TOKEN }}
        
    - name: ğŸ—ï¸ Build Docker image
      run: |
        docker build -f Dockerfile.clever -t virida-infrastructure:latest .
        
    - name: ğŸš€ Deploy to Clever Cloud
      run: |
        clever deploy --same-commit-policy rebuild
      env:
        CC_APP_DOMAIN: ${{ secrets.CC_APP_DOMAIN }}
        CC_POSTGRESQL_ADDON_HOST: ${{ secrets.CC_POSTGRESQL_ADDON_HOST }}
        CC_POSTGRESQL_ADDON_DB: ${{ secrets.CC_POSTGRESQL_ADDON_DB }}
        CC_POSTGRESQL_ADDON_USER: ${{ secrets.CC_POSTGRESQL_ADDON_USER }}
        CC_POSTGRESQL_ADDON_PASSWORD: ${{ secrets.CC_POSTGRESQL_ADDON_PASSWORD }}
        GITEA_SECRET_KEY: ${{ secrets.GITEA_SECRET_KEY }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        GRAFANA_ADMIN_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        CC_ACME_EMAIL: ${{ secrets.CC_ACME_EMAIL }}
        
    - name: âœ… Health Check
      run: |
        echo "â³ Waiting for deployment to be ready..."
        sleep 60
        for i in {1..10}; do
          if curl -f https://${{ secrets.CC_APP_DOMAIN }}/health; then
            echo "âœ… Health check passed!"
            break
          fi
          echo "â³ Attempt $i/10 failed, retrying in 30s..."
          sleep 30
        done
        
    - name: ğŸ“Š Performance Test
      run: |
        echo "ğŸš€ Running performance tests..."
        response_time=$(curl -o /dev/null -s -w '%{time_total}' https://${{ secrets.CC_APP_DOMAIN }}/health)
        echo "Response time: ${response_time}s"
        if (( $(echo "$response_time > 5.0" | bc -l) )); then
          echo "âš ï¸ Warning: Response time is high (${response_time}s)"
        else
          echo "âœ… Performance test passed (${response_time}s)"
        fi
        
    - name: ğŸ“¢ Notify Success
      if: success()
      run: |
        echo "âœ… VIRIDA deployed successfully to Clever Cloud!"
        echo "ğŸŒ URL: https://${{ secrets.CC_APP_DOMAIN }}"
        echo "ğŸ“Š Environment: ${{ github.ref_name }}"
        echo "ğŸ• Deployment time: $(date)"
        
    - name: âŒ Notify Failure
      if: failure()
      run: |
        echo "âŒ VIRIDA deployment failed!"
        echo "ğŸ” Check the logs above for details"
        exit 1
