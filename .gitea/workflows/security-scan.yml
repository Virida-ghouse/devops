name: ðŸ”’ Security Scan

on:
  push:
    branches: [ main, staging, develop ]
  pull_request:
    branches: [ main, staging ]
  schedule:
    # Scan quotidien Ã  2h du matin
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    name: ðŸ”’ Security Scan VIRIDA
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name:  Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name:  Install Trivy
      run: |
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
    - name: ðŸ”§ Install hadolint
      run: |
        wget -O hadolint "https://github.com/hadolint/hadolint/releases/latest/download/hadolint-$(uname -s)-$(uname -m)"
        chmod +x hadolint
        sudo mv hadolint /usr/local/bin/
        
    - name: ðŸ”§ Install Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: ðŸ”§ Install Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ”§ Install Python security tools
      run: |
        pip install safety bandit
        
    - name: ðŸ—ï¸ Build optimized images
      run: |
        # Construire les images optimisÃ©es
        cd frontend/3d-visualizer
        docker build --tag virida-3d-visualizer:scan -f Dockerfile.optimized .
        cd ../../backend/api-gateway
        docker build --tag virida-api-gateway:scan -f Dockerfile.optimized .
        cd ../../ai-ml/prediction-engine
        docker build --tag virida-ai-prediction:scan -f Dockerfile.optimized .
        cd ../../gitea-virida-bridge
        docker build --tag gitea-virida-bridge:scan -f Dockerfile.optimized .
        
    - name: ðŸ” Scan Docker images with Trivy
      run: |
        mkdir -p security-results/images
        
        # Scanner les images
        trivy image --format json --output security-results/images/virida-3d-visualizer-vulnerabilities.json virida-3d-visualizer:scan
        trivy image --format json --output security-results/images/virida-api-gateway-vulnerabilities.json virida-api-gateway:scan
        trivy image --format json --output security-results/images/virida-ai-prediction-vulnerabilities.json virida-ai-prediction:scan
        trivy image --format json --output security-results/images/gitea-virida-bridge-vulnerabilities.json gitea-virida-bridge:scan
        
        # Rapports lisibles
        trivy image --format table --output security-results/images/virida-3d-visualizer-report.txt virida-3d-visualizer:scan
        trivy image --format table --output security-results/images/virida-api-gateway-report.txt virida-api-gateway:scan
        trivy image --format table --output security-results/images/virida-ai-prediction-report.txt virida-ai-prediction:scan
        trivy image --format table --output security-results/images/gitea-virida-bridge-report.txt gitea-virida-bridge:scan
        
    - name: ðŸ” Scan Node.js dependencies
      run: |
        mkdir -p security-results/dependencies
        
        # Scanner les dÃ©pendances Node.js
        cd frontend/3d-visualizer
        npm audit --json > ../../security-results/dependencies/3d-visualizer-npm-audit.json 2>/dev/null || echo '{"vulnerabilities": {}}' > ../../security-results/dependencies/3d-visualizer-npm-audit.json
        cd ../../backend/api-gateway
        npm audit --json > ../../security-results/dependencies/api-gateway-npm-audit.json 2>/dev/null || echo '{"vulnerabilities": {}}' > ../../security-results/dependencies/api-gateway-npm-audit.json
        cd ../../gitea-virida-bridge
        npm audit --json > ../../security-results/dependencies/gitea-virida-bridge-npm-audit.json 2>/dev/null || echo '{"vulnerabilities": {}}' > ../../security-results/dependencies/gitea-virida-bridge-npm-audit.json
        
    - name: ðŸ” Scan Python dependencies
      run: |
        mkdir -p security-results/dependencies
        
        # Scanner les dÃ©pendances Python
        cd ai-ml/prediction-engine
        safety check --json --output ../../security-results/dependencies/prediction-engine-safety.json 2>/dev/null || echo '[]' > ../../security-results/dependencies/prediction-engine-safety.json
        
    - name: ðŸ” Scan Python code with bandit
      run: |
        mkdir -p security-results/code
        
        # Scanner le code Python
        bandit -r ai-ml/prediction-engine -f json -o security-results/code/prediction-engine-bandit.json 2>/dev/null || echo '{"results": []}' > security-results/code/prediction-engine-bandit.json
        
    - name: ðŸ” Lint Dockerfiles with hadolint
      run: |
        mkdir -p security-results/code
        
        # Linter les Dockerfiles
        hadolint frontend/3d-visualizer/Dockerfile.optimized --format json > security-results/code/3d-visualizer-dockerfile-hadolint.json 2>/dev/null || echo '[]' > security-results/code/3d-visualizer-dockerfile-hadolint.json
        hadolint backend/api-gateway/Dockerfile.optimized --format json > security-results/code/api-gateway-dockerfile-hadolint.json 2>/dev/null || echo '[]' > security-results/code/api-gateway-dockerfile-hadolint.json
        hadolint ai-ml/prediction-engine/Dockerfile.optimized --format json > security-results/code/prediction-engine-dockerfile-hadolint.json 2>/dev/null || echo '[]' > security-results/code/prediction-engine-dockerfile-hadolint.json
        hadolint gitea-virida-bridge/Dockerfile.optimized --format json > security-results/code/gitea-virida-bridge-dockerfile-hadolint.json 2>/dev/null || echo '[]' > security-results/code/gitea-virida-bridge-dockerfile-hadolint.json
        
    - name: ðŸ“Š Generate security summary
      run: |
        # CrÃ©er un rÃ©sumÃ© des scans
        cat > security-results/security-summary.json << EOF
        {
          "scan_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "workflow_run": "${{ github.run_id }}",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "scans_performed": [
            "docker_images_trivy",
            "nodejs_dependencies_npm_audit",
            "python_dependencies_safety",
            "python_code_bandit",
            "dockerfiles_hadolint"
          ],
          "results_directory": "security-results"
        }
        EOF
        
    - name: ðŸ“¤ Upload security results
      uses: actions/upload-artifact@v3
      with:
        name: security-scan-results
        path: security-results/
        retention-days: 30
        
    - name: ðŸ“Š Security summary
      run: |
        echo "ðŸ”’ Security Scan Summary"
        echo "========================"
        echo "ðŸ“… Date: $(date)"
        echo "ðŸ”„ Workflow: ${{ github.run_id }}"
        echo "ðŸ“ Commit: ${{ github.sha }}"
        echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
        echo ""
        echo "ðŸ“Š Scans performed:"
        echo "  âœ… Docker images (Trivy)"
        echo "  âœ… Node.js dependencies (npm audit)"
        echo "  âœ… Python dependencies (safety)"
        echo "  âœ… Python code (bandit)"
        echo "  âœ… Dockerfiles (hadolint)"
        echo ""
        echo "ðŸ“ Results uploaded as artifact: security-scan-results"
        echo "ðŸ”„ Next scan: Daily at 2:00 AM UTC"
  sonarqube-analysis:
    name: ðŸ“ˆ SonarQube Quality Gate
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: secrets.SONAR_TOKEN != '' && secrets.SONAR_HOST_URL != ''
    env:
      NODE_VERSION: '18'
      SONAR_SCANNER_VERSION: '5.0.1.3006'
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            virida_app/package-lock.json
            virida_api/package-lock.json

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: ðŸ“¦ Install SonarScanner CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          mkdir -p $HOME/.sonar
          curl -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${{ env.SONAR_SCANNER_VERSION }}-linux.zip
          unzip -q $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          mv $HOME/.sonar/sonar-scanner-${{ env.SONAR_SCANNER_VERSION }}-linux $HOME/.sonar/sonar-scanner
          echo "$HOME/.sonar/sonar-scanner/bin" >> $GITHUB_PATH

      - name: ðŸ“¦ Install frontend dependencies
        working-directory: virida_app
        run: npm ci

      - name: ðŸ“Š SonarQube scan (virida_app)
        working-directory: virida_app
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=virida_app_frontend \
            -Dsonar.projectName="VIRIDA Frontend" \
            -Dsonar.projectVersion=${GITHUB_SHA:-dev} \
            -Dsonar.sources=src \
            -Dsonar.exclusions=src/**/*.test.ts,src/**/*.test.tsx,src/**/*.stories.tsx,src/**/*.spec.tsx \
            -Dsonar.typescript.tsconfigPath=tsconfig.json \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN

      - name: ðŸ“¦ Install backend dependencies
        working-directory: virida_api
        run: npm ci

      - name: ðŸ§ª Backend tests with coverage
        working-directory: virida_api
        env:
          NODE_ENV: test
        run: npm run test -- --coverage --runInBand

      - name: ðŸ“Š SonarQube scan (virida_api)
        working-directory: virida_api
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=virida_api_backend \
            -Dsonar.projectName="VIRIDA API" \
            -Dsonar.projectVersion=${GITHUB_SHA:-dev} \
            -Dsonar.sources=src \
            -Dsonar.tests=tests \
            -Dsonar.test.inclusions=tests/**/*.test.js \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
            -Dsonar.coverage.exclusions=tests/** \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.login=$SONAR_TOKEN
